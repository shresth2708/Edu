// This is your Prisma schema file for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TestType {
  QUIZ
  ASSIGNMENT
  MOCK_TEST
  FINAL_EXAM
}

enum QuestionType {
  MCQ
  MULTIPLE_SELECT
  TRUE_FALSE
  SHORT_ANSWER
  LONG_ANSWER
}

enum LiveClassStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

// Models

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  phone             String?             @unique
  password          String
  role              UserRole
  firstName         String
  lastName          String
  avatar            String?
  isEmailVerified   Boolean             @default(false)
  isPhoneVerified   Boolean             @default(false)
  isActive          Boolean             @default(true)
  lastLogin         DateTime?
  referralCode      String              @unique
  referredBy        String?
  twoFactorEnabled  Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  teacherProfile    TeacherProfile?
  studentProfile    StudentProfile?
  parentProfile     ParentProfile?
  instituteMemberships InstituteMember[]
  coursesCreated    Course[]            @relation("CourseCreator")
  enrollments       Enrollment[]
  payments          Payment[]
  testAttempts      TestAttempt[]
  notifications     Notification[]
  achievements      Achievement[]
  liveClassesHosted LiveClass[]         @relation("LiveClassHost")
  liveClassAttendance LiveClassAttendance[]
  doubts            Doubt[]             @relation("DoubtAsker")
  doubtAnswers      DoubtAnswer[]       @relation("DoubtAnswerer")
  refreshTokens     RefreshToken[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model TeacherProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio               String?
  expertise         String[]
  experience        Int?     // years
  qualification     String?
  linkedIn          String?
  website           String?
  rating            Float    @default(0)
  totalStudents     Int      @default(0)
  totalCourses      Int      @default(0)
  totalRevenue      Float    @default(0)
  
  subscriptionPlan  SubscriptionPlan @default(FREE)
  subscriptionEndsAt DateTime?
  
  bankAccountNumber String?
  bankIFSC          String?
  bankAccountName   String?
  upiId             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("teacher_profiles")
}

model StudentProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  grade             String?
  school            String?
  city              String?
  state             String?
  country           String   @default("India")
  
  // Gamification
  xp                Int      @default(0)
  level             Int      @default(1)
  streak            Int      @default(0)
  lastActiveDate    DateTime?
  totalCoursesEnrolled Int   @default(0)
  totalCoursesCompleted Int  @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("student_profiles")
}

model ParentProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  childrenIds       String[] // Array of student user IDs
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("parent_profiles")
}

model Institute {
  id                String   @id @default(uuid())
  name              String
  slug              String   @unique
  logo              String?
  description       String?
  website           String?
  email             String?
  phone             String?
  
  address           String?
  city              String?
  state             String?
  country           String   @default("India")
  pincode           String?
  
  subscriptionPlan  SubscriptionPlan @default(FREE)
  subscriptionEndsAt DateTime?
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members           InstituteMember[]
  courses           Course[]
  batches           Batch[]

  @@map("institutes")
}

model InstituteMember {
  id                String   @id @default(uuid())
  instituteId       String
  institute         Institute @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role              String   // OWNER, ADMIN, TEACHER, STAFF
  permissions       String[] // Array of permission strings
  
  joinedAt          DateTime @default(now())
  
  @@unique([instituteId, userId])
  @@map("institute_members")
}

model Category {
  id                String   @id @default(uuid())
  name              String
  slug              String   @unique
  description       String?
  icon              String?
  parentId          String?
  parent            Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children          Category[] @relation("CategoryHierarchy")
  
  courses           Course[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("categories")
}

model Course {
  id                String        @id @default(uuid())
  title             String
  slug              String        @unique
  description       String?
  thumbnail         String?
  trailerVideo      String?
  
  creatorId         String
  creator           User          @relation("CourseCreator", fields: [creatorId], references: [id])
  
  instituteId       String?
  institute         Institute?    @relation(fields: [instituteId], references: [id])
  
  categoryId        String?
  category          Category?     @relation(fields: [categoryId], references: [id])
  
  status            CourseStatus  @default(DRAFT)
  isPublished       Boolean       @default(false)
  publishedAt       DateTime?
  
  // Pricing
  isFree            Boolean       @default(false)
  price             Float         @default(0)
  discountedPrice   Float?
  currency          String        @default("INR")
  
  // Course metadata
  language          String        @default("English")
  level             String?       // Beginner, Intermediate, Advanced
  duration          Int?          // in hours
  totalLessons      Int           @default(0)
  totalStudents     Int           @default(0)
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  tags              String[]
  
  // Settings
  allowComments     Boolean       @default(true)
  issueCertificate  Boolean       @default(false)
  certificateTemplate String?
  
  rating            Float         @default(0)
  totalRatings      Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  sections          Section[]
  enrollments       Enrollment[]
  batches           Batch[]
  reviews           CourseReview[]
  coupons           Coupon[]

  @@index([slug])
  @@index([creatorId])
  @@index([status])
  @@map("courses")
}

model Section {
  id                String   @id @default(uuid())
  courseId          String
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?
  order             Int
  isPublished       Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  lessons           Lesson[]

  @@unique([courseId, order])
  @@map("sections")
}

model Lesson {
  id                String   @id @default(uuid())
  sectionId         String
  section           Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?
  type              String   // VIDEO, PDF, QUIZ, ASSIGNMENT, LIVE_CLASS
  content           String?  // URL or content based on type
  duration          Int?     // in minutes
  order             Int
  
  // Video specific
  videoUrl          String?
  videoProvider     String?  // AWS, MUX, YOUTUBE
  videoDuration     Int?
  
  // Document specific
  documentUrl       String?
  
  isFree            Boolean  @default(false)
  isPublished       Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  progress          LessonProgress[]

  @@unique([sectionId, order])
  @@map("lessons")
}

model Enrollment {
  id                String            @id @default(uuid())
  courseId          String
  course            Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  studentId         String
  student           User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  status            EnrollmentStatus  @default(ACTIVE)
  progress          Float             @default(0) // 0-100
  
  enrolledAt        DateTime          @default(now())
  expiresAt         DateTime?
  completedAt       DateTime?
  
  // Relations
  lessonProgress    LessonProgress[]

  @@unique([courseId, studentId])
  @@map("enrollments")
}

model LessonProgress {
  id                String     @id @default(uuid())
  enrollmentId      String
  enrollment        Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  lessonId          String
  lesson            Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  isCompleted       Boolean    @default(false)
  progress          Float      @default(0) // 0-100
  timeSpent         Int        @default(0) // in seconds
  lastWatchedAt     DateTime?
  completedAt       DateTime?
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

model Batch {
  id                String   @id @default(uuid())
  name              String
  description       String?
  
  courseId          String
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  instituteId       String?
  institute         Institute? @relation(fields: [instituteId], references: [id])
  
  startDate         DateTime
  endDate           DateTime?
  maxStudents       Int?
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  liveClasses       LiveClass[]

  @@map("batches")
}

model LiveClass {
  id                String            @id @default(uuid())
  title             String
  description       String?
  
  batchId           String?
  batch             Batch?            @relation(fields: [batchId], references: [id])
  
  hostId            String
  host              User              @relation("LiveClassHost", fields: [hostId], references: [id])
  
  scheduledAt       DateTime
  startedAt         DateTime?
  endedAt           DateTime?
  duration          Int?              // in minutes
  
  meetingLink       String?
  meetingId         String?
  meetingPassword   String?
  platform          String?           // ZOOM, GOOGLE_MEET, CUSTOM
  
  status            LiveClassStatus   @default(SCHEDULED)
  recordingUrl      String?
  
  maxAttendees      Int?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  attendance        LiveClassAttendance[]

  @@map("live_classes")
}

model LiveClassAttendance {
  id                String    @id @default(uuid())
  liveClassId       String
  liveClass         LiveClass @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  
  studentId         String
  student           User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  joinedAt          DateTime
  leftAt            DateTime?
  duration          Int?      // in minutes
  
  @@unique([liveClassId, studentId])
  @@map("live_class_attendance")
}

model Test {
  id                String      @id @default(uuid())
  title             String
  description       String?
  
  type              TestType
  totalMarks        Int
  passingMarks      Int
  duration          Int         // in minutes
  
  instructions      String?
  
  isPublished       Boolean     @default(false)
  startTime         DateTime?
  endTime           DateTime?
  
  showResults       Boolean     @default(true)
  showAnswers       Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  questions         Question[]
  attempts          TestAttempt[]

  @@map("tests")
}

model Question {
  id                String        @id @default(uuid())
  testId            String
  test              Test          @relation(fields: [testId], references: [id], onDelete: Cascade)
  
  type              QuestionType
  question          String
  options           String[]      // For MCQ
  correctAnswer     String[]      // Can be multiple for MULTIPLE_SELECT
  explanation       String?
  marks             Int
  negativeMarks     Float         @default(0)
  
  order             Int
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  answers           Answer[]

  @@map("questions")
}

model TestAttempt {
  id                String    @id @default(uuid())
  testId            String
  test              Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  
  studentId         String
  student           User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  startedAt         DateTime  @default(now())
  submittedAt       DateTime?
  
  totalMarks        Int
  marksObtained     Float?
  percentage        Float?
  rank              Int?
  
  timeSpent         Int?      // in seconds
  
  // Relations
  answers           Answer[]

  @@map("test_attempts")
}

model Answer {
  id                String      @id @default(uuid())
  attemptId         String
  attempt           TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId        String
  question          Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  selectedAnswer    String[]    // User's answer
  isCorrect         Boolean?
  marksAwarded      Float?
  
  timeTaken         Int?        // in seconds
  
  @@unique([attemptId, questionId])
  @@map("answers")
}

model Payment {
  id                String        @id @default(uuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  
  amount            Float
  currency          String        @default("INR")
  
  paymentFor        String        // COURSE, SUBSCRIPTION, etc.
  referenceId       String        // Course ID or Subscription ID
  
  paymentMethod     String        // RAZORPAY, STRIPE, UPI, etc.
  transactionId     String?       @unique
  
  status            PaymentStatus @default(PENDING)
  
  paymentDetails    Json?         // Store gateway response
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@map("payments")
}

model Coupon {
  id                String    @id @default(uuid())
  code              String    @unique
  
  courseId          String?
  course            Course?   @relation(fields: [courseId], references: [id])
  
  discountType      String    // PERCENTAGE, FIXED
  discountValue     Float
  maxDiscount       Float?
  
  minPurchase       Float?
  maxUses           Int?
  usedCount         Int       @default(0)
  
  validFrom         DateTime
  validUntil        DateTime
  
  isActive          Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("coupons")
}

model CourseReview {
  id                String    @id @default(uuid())
  courseId          String
  course            Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  studentId         String
  
  rating            Int       // 1-5
  review            String?
  
  isPublished       Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([courseId, studentId])
  @@map("course_reviews")
}

model Achievement {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              String    // BADGE, MILESTONE, STREAK
  title             String
  description       String?
  icon              String?
  
  xpAwarded         Int       @default(0)
  
  earnedAt          DateTime  @default(now())

  @@map("achievements")
}

model Doubt {
  id                String    @id @default(uuid())
  studentId         String
  student           User      @relation("DoubtAsker", fields: [studentId], references: [id], onDelete: Cascade)
  
  title             String
  description       String
  attachments       String[]
  
  courseId          String?
  lessonId          String?
  
  isResolved        Boolean   @default(false)
  resolvedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  answers           DoubtAnswer[]

  @@map("doubts")
}

model DoubtAnswer {
  id                String    @id @default(uuid())
  doubtId           String
  doubt             Doubt     @relation(fields: [doubtId], references: [id], onDelete: Cascade)
  
  answeredById      String
  answeredBy        User      @relation("DoubtAnswerer", fields: [answeredById], references: [id], onDelete: Cascade)
  
  answer            String
  attachments       String[]
  
  isAccepted        Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("doubt_answers")
}

model Notification {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title             String
  message           String
  type              String    // INFO, SUCCESS, WARNING, ERROR
  
  actionUrl         String?
  
  isRead            Boolean   @default(false)
  readAt            DateTime?
  
  createdAt         DateTime  @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

model RefreshToken {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token             String    @unique
  expiresAt         DateTime
  
  createdAt         DateTime  @default(now())

  @@index([token])
  @@map("refresh_tokens")
}
